generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  password             String
  name                 String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  
  // Role & Status
  role                 String                @default("owner")   // owner, super_admin, admin, member
  status               String                @default("active")  // active, inactive
  
  // Account ownership (for team members)
  accountOwnerId       String?
  accountOwner         User?                 @relation("TeamMembers", fields: [accountOwnerId], references: [id])
  teamMembers          User[]                @relation("TeamMembers")
  
  // Profile fields
  firstName            String?
  lastName             String?
  phone                String?
  timezone             String?               @default("America/Chicago")
  
  // Company info (typically only for owner)
  companyName          String?
  companyEmail         String?
  companyPhone         String?
  billingAddress       String?
  billingCity          String?
  billingState         String?
  billingZip           String?
  billingCountry       String?               @default("United States")
  
  // Relations
  systemLogs           ActivityLog[]
  notifications        Notification[]
  assignedRecords      Record[]
  createdRecords       Record[]              @relation("RecordCreator")
  activityLogs         RecordActivityLog[]
  comments             RecordComment[]
  assignedTasks        Task[]                @relation("TaskAssignee")
  createdTasks         Task[]                @relation("TaskCreator")
  createdTags          Tag[]                 @relation("TagCreator")
  createdMotivations   Motivation[]          @relation("MotivationCreator")
  createdStatuses      Status[]              @relation("StatusCreator")
  createdCustomFields  CustomFieldDefinition[] @relation("CustomFieldCreator")
  createdTaskTemplates TaskTemplate[]        @relation("TaskTemplateCreator")
  createdFilterFolders FilterFolder[]        @relation("FilterFolderCreator")
  createdFilterTemplates FilterTemplate[]    @relation("FilterTemplateCreator")
  createdBoards        Board[]               @relation("BoardCreator")
  createdAutomationFolders AutomationFolder[] @relation("AutomationFolderCreator")
  createdAutomations   Automation[]          @relation("AutomationCreator")
  createdDashboards    AnalyticsDashboard[]  @relation("DashboardCreator")
}

model Property {
  id               String               @id @default(cuid())
  address          String               @unique
  zpid             String?
  streetAddress    String?
  city             String?
  state            String?
  zipcode          String?
  bedrooms         Int?
  bathrooms        Float?
  livingArea       Int?
  yearBuilt        Int?
  homeType         String?
  price            Float?
  zestimate        Float?
  priceHistory     Json?
  zestimateHistory Json?
  rawData          Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  motivations      PropertyMotivation[]
  statuses         PropertyStatus[]
  tags             PropertyTag[]
}

model Tag {
  id          String        @id @default(cuid())
  name        String
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User?         @relation("TagCreator", fields: [createdById], references: [id])
  properties  PropertyTag[]
  records     RecordTag[]

  @@unique([name, createdById])
}

model Motivation {
  id          String               @id @default(cuid())
  name        String
  createdById String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdBy   User?                @relation("MotivationCreator", fields: [createdById], references: [id])
  properties  PropertyMotivation[]
  records     RecordMotivation[]

  @@unique([name, createdById])
}

model PropertyTag {
  id         String   @id @default(cuid())
  propertyId String
  tagId      String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id])

  @@unique([propertyId, tagId])
}

model PropertyMotivation {
  id           String     @id @default(cuid())
  propertyId   String
  motivationId String
  createdAt    DateTime   @default(now())
  motivation   Motivation @relation(fields: [motivationId], references: [id])
  property     Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, motivationId])
}

model Status {
  id          String           @id @default(cuid())
  name        String
  color       String
  isDefault   Boolean          @default(false)
  isActive    Boolean          @default(true)
  order       Int              @default(0)
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   User?            @relation("StatusCreator", fields: [createdById], references: [id])
  properties  PropertyStatus[]
  records     Record[]

  @@unique([name, createdById])
}

model PropertyStatus {
  id         String   @id @default(cuid())
  propertyId String
  statusId   String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  status     Status   @relation(fields: [statusId], references: [id])

  @@unique([propertyId, statusId])
}

model Record {
  id                 String              @id @default(cuid())
  ownerFirstName     String?
  ownerLastName      String?
  ownerFullName      String
  isCompany          Boolean             @default(false)
  isCompanyOverride  Boolean?
  propertyStreet     String?
  propertyCity       String?
  propertyState      String?
  propertyZip        String?
  mailingStreet      String?
  mailingCity        String?
  mailingState       String?
  mailingZip         String?
  phone              String?
  email              String?
  notes              String?
  description        String?
  temperature        String?
  estimatedValue     Decimal?
  bedrooms           Int?
  bathrooms          Decimal?
  sqft               Int?
  lotSize            Decimal?
  structureType      String?
  heatingType        String?
  airConditioner     String?
  yearBuilt          Int?
  callAttempts       Int                 @default(0)
  directMailAttempts Int                 @default(0)
  smsAttempts        Int                 @default(0)
  rvmAttempts        Int                 @default(0)
  isContact          Boolean             @default(false)
  isComplete         Boolean             @default(false)
  statusId           String?
  assignedToId       String?
  createdById        String?
  skiptraceDate      DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  
  // DockInsight 2.2.2: Denormalized counters for analytics
  phoneCount         Int                 @default(0)
  emailCount         Int                 @default(0)
  tagCount           Int                 @default(0)
  motivationCount    Int                 @default(0)
  
  customFieldValues  CustomFieldValue[]
  notifications      Notification[]
  assignedTo         User?               @relation(fields: [assignedToId], references: [id])
  createdBy          User?               @relation("RecordCreator", fields: [createdById], references: [id])
  status             Status?             @relation(fields: [statusId], references: [id])
  activityLogs       RecordActivityLog[]
  comments           RecordComment[]
  emails             RecordEmail[]
  recordMotivations  RecordMotivation[]
  phoneNumbers       RecordPhoneNumber[]
  recordTags         RecordTag[]
  tasks              Task[]
  boardPositions     RecordBoardPosition[]
  
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([createdById, temperature])
  @@index([createdById, statusId])
  @@index([createdById, assignedToId])
}

model RecordTag {
  id          String   @id @default(cuid())
  recordId    String
  tagId       String
  createdById String?  // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tagId], references: [id])

  @@unique([recordId, tagId])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([recordId])
  @@index([tagId])
}

model RecordMotivation {
  id           String     @id @default(cuid())
  recordId     String
  motivationId String
  createdById  String?    // DockInsight 2.2.2: Tenant scope for analytics
  createdAt    DateTime   @default(now())
  motivation   Motivation @relation(fields: [motivationId], references: [id])
  record       Record     @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([recordId, motivationId])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([recordId])
  @@index([motivationId])
}

model RecordPhoneNumber {
  id          String   @id @default(cuid())
  recordId    String
  number      String
  type        String   @default("MOBILE")
  statuses    String[] @default([])
  createdById String?  // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)

  // DockInsight 2.2.2: Analytics indexes
  @@index([recordId])
  @@index([createdById])
  @@index([createdById, createdAt])
}

model RecordEmail {
  id          String   @id @default(cuid())
  recordId    String
  email       String
  isPrimary   Boolean  @default(false)
  createdById String?  // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)

  // DockInsight 2.2.2: Analytics indexes
  @@index([recordId])
  @@index([createdById])
  @@index([createdById, createdAt])
}

model RecordComment {
  id        String   @id @default(cuid())
  recordId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([recordId])
  @@index([userId])
}

model RecordActivityLog {
  id        String   @id @default(cuid())
  recordId  String
  userId    String?
  action    String
  field     String?
  oldValue  String?
  newValue  String?
  source    String?
  createdAt DateTime @default(now())
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([recordId])
  @@index([userId])
  @@index([createdAt])
}

model CustomFieldDefinition {
  id          String             @id @default(cuid())
  name        String
  fieldType   String
  displayType String             @default("card")
  options     String?
  isRequired  Boolean            @default(false)
  order       Int                @default(0)
  createdById String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  createdBy   User?              @relation("CustomFieldCreator", fields: [createdById], references: [id])
  values      CustomFieldValue[]

  @@unique([name, createdById])
}

model CustomFieldValue {
  id        String                @id @default(cuid())
  value     String?
  fieldId   String
  recordId  String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  record    Record                @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([fieldId, recordId])
  @@index([recordId])
  @@index([fieldId])
}

model ActivityLog {
  id           String   @id @default(cuid())
  type         String
  action       String
  filename     String?
  description  String?
  total        Int      @default(0)
  processed    Int      @default(0)
  status       String   @default("pending")
  metadata     Json?
  errorMessage String?
  userId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User?    @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model Task {
  id              String         @id @default(cuid())
  title           String
  description     String?
  dueDate         DateTime?
  dueTime         String?
  notifyAfter     Int?
  notifyAfterUnit String?
  repeatCount     Int?
  startDate       DateTime?
  recurrence      String?
  recurrenceDays  String[]       @default([])
  skipWeekends    Boolean        @default(false)
  status          String         @default("PENDING")
  priority        String         @default("MEDIUM")
  assignmentType  String         @default("MANUAL")
  assignedToId    String?
  recordId        String?
  createdById     String
  templateId      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?
  notifications  Notification[]
  assignedTo     User?          @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy      User           @relation("TaskCreator", fields: [createdById], references: [id])
  record         Record?        @relation(fields: [recordId], references: [id])
  template       TaskTemplate?  @relation(fields: [templateId], references: [id])

  @@index([assignedToId])
  @@index([recordId])
  @@index([status])
  @@index([dueDate])
  @@index([createdById])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById, createdAt])
  @@index([createdById, status])
  @@index([createdById, priority])
}

model TaskTemplate {
  id              String   @id @default(cuid())
  name            String
  title           String
  description     String?
  category        String?
  priority        String   @default("MEDIUM")
  dueDaysFromNow  Int?
  dueTime         String?
  recurrence      String?
  recurrenceDays  String[] @default([])
  skipWeekends    Boolean  @default(false)
  assignmentType  String   @default("MANUAL")
  roundRobinUsers String[] @default([])
  createdById     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       User?    @relation("TaskTemplateCreator", fields: [createdById], references: [id])
  tasks           Task[]

  @@unique([name, createdById])
  @@index([category])
}

model RoundRobinState {
  id           String   @id @default(cuid())
  identifier   String   @unique
  userIds      String[]
  currentIndex Int      @default(0)
  updatedAt    DateTime @updatedAt
}

model Notification {
  id           String    @id @default(cuid())
  userId       String
  type         String
  title        String
  message      String
  taskId       String?
  recordId     String?
  deliveryType String    @default("IMMEDIATE")
  scheduledFor DateTime?
  isRead       Boolean   @default(false)
  readAt       DateTime?
  isDismissed  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  record       Record?   @relation(fields: [recordId], references: [id])
  task         Task?     @relation(fields: [taskId], references: [id])
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

model FilterFolder {
  id          String           @id @default(cuid())
  name        String
  order       Int              @default(0)
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   User?            @relation("FilterFolderCreator", fields: [createdById], references: [id])
  templates   FilterTemplate[]

  @@unique([name, createdById])
}

model FilterTemplate {
  id          String        @id @default(cuid())
  name        String
  filters     Json
  folderId    String?
  folder      FilterFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  order       Int           @default(0)
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User?         @relation("FilterTemplateCreator", fields: [createdById], references: [id])

  @@unique([name, createdById])
  @@index([folderId])
}

// Kanban Board Models
model Board {
  id          String        @id @default(cuid())
  name        String
  description String?
  createdById String
  createdBy   User          @relation("BoardCreator", fields: [createdById], references: [id])
  columns     BoardColumn[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
}

model BoardColumn {
  id        String                @id @default(cuid())
  name      String
  color     String                @default("#6366f1")
  order     Int                   @default(0)
  boardId   String
  board     Board                 @relation(fields: [boardId], references: [id], onDelete: Cascade)
  records   RecordBoardPosition[]
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([boardId])
  @@index([order])
}

model RecordBoardPosition {
  id        String      @id @default(cuid())
  recordId  String
  record    Record      @relation(fields: [recordId], references: [id], onDelete: Cascade)
  columnId  String
  column    BoardColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([recordId, columnId])
  @@index([columnId])
  @@index([recordId])
}

// ==========================================
// AUTOMATION SYSTEM
// ==========================================

model AutomationFolder {
  id          String       @id @default(cuid())
  name        String
  description String?
  color       String       @default("#6366f1")
  order       Int          @default(0)
  createdById String
  createdBy   User         @relation("AutomationFolderCreator", fields: [createdById], references: [id])
  automations Automation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
  @@index([order])
}

model Automation {
  id          String            @id @default(cuid())
  name        String
  description String?
  folderId    String?
  folder      AutomationFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  isActive    Boolean           @default(false)
  isDraft     Boolean           @default(true)
  
  // Workflow definition stored as JSON
  // Contains: triggers, nodes, edges, viewport
  workflowData Json?
  
  // Statistics
  runCount    Int               @default(0)
  lastRunAt   DateTime?
  
  createdById String
  createdBy   User              @relation("AutomationCreator", fields: [createdById], references: [id])
  logs        AutomationLog[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
  @@index([folderId])
  @@index([isActive])
}

model AutomationLog {
  id           String     @id @default(cuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  recordId     String?
  
  // Execution details
  triggeredBy  String     // trigger type that started this run
  status       String     @default("running") // running, completed, failed, skipped
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  
  // Step-by-step execution log
  steps        Json?      // Array of { nodeId, status, startedAt, completedAt, error? }
  
  // Error tracking
  errorMessage String?
  errorNodeId  String?
  
  createdAt    DateTime   @default(now())

  @@index([automationId])
  @@index([recordId])
  @@index([status])
  @@index([createdAt])
}

// =============================================================================
// DockInsight 2.2.2: Analytics Dashboard Models
// =============================================================================

model AnalyticsDashboard {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  
  // Layout settings
  columns     Int      @default(12)
  
  // Global filters (stored as JSON)
  globalFilters Json?
  
  // Ownership
  createdById String
  createdBy   User     @relation("DashboardCreator", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Widgets
  widgets     AnalyticsWidget[]
  
  @@index([createdById])
  @@index([createdById, isDefault])
}

model AnalyticsWidget {
  id          String   @id @default(cuid())
  dashboardId String
  dashboard   AnalyticsDashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  
  // Display
  title       String
  type        String   // metric, chart, pie, table, line
  
  // Query configuration
  entityKey   String
  segmentKey  String?
  metric      Json     // { key, field?, filter? }
  dimension   String?
  filters     Json?    // FilterPredicate[]
  dateRange   Json?    // DateRange override
  dateMode    String?
  granularity String?
  sort        Json?    // { field, dir }
  limit       Int?
  
  // Grid position
  x           Int      @default(0)
  y           Int      @default(0)
  w           Int      @default(6)
  h           Int      @default(2)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([dashboardId])
}
