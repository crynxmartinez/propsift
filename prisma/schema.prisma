generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Role & Status
  role            String  @default("owner") // owner, super_admin, admin, member
  status          String  @default("pending") // pending, active, inactive
  isPlatformAdmin Boolean @default(false) // Platform-level admin (PropSift staff only)

  // Email verification
  emailVerified         Boolean   @default(false)
  verificationToken     String?   @unique
  verificationExpires   DateTime?
  lastVerificationSentAt DateTime?
  registrationIp        String?

  // Account ownership (for team members)
  accountOwnerId String?
  accountOwner   User?   @relation("TeamMembers", fields: [accountOwnerId], references: [id])
  teamMembers    User[]  @relation("TeamMembers")

  // Profile fields
  firstName String?
  lastName  String?
  phone     String?
  timezone  String? @default("America/Chicago")

  // Company info (typically only for owner)
  companyName    String?
  companyEmail   String?
  companyPhone   String?
  billingAddress String?
  billingCity    String?
  billingState   String?
  billingZip     String?
  billingCountry String? @default("United States")

  // Relations
  systemLogs               ActivityLog[]
  notifications            Notification[]
  assignedRecords          Record[]
  createdRecords           Record[]                @relation("RecordCreator")
  activityLogs             RecordActivityLog[]
  comments                 RecordComment[]
  assignedTasks            Task[]                  @relation("TaskAssignee")
  createdTasks             Task[]                  @relation("TaskCreator")
  createdTags              Tag[]                   @relation("TagCreator")
  createdMotivations       Motivation[]            @relation("MotivationCreator")
  createdStatuses          Status[]                @relation("StatusCreator")
  createdCallResults       CallResult[]            @relation("CallResultCreator")
  createdCustomFields      CustomFieldDefinition[] @relation("CustomFieldCreator")
  createdTaskTemplates     TaskTemplate[]          @relation("TaskTemplateCreator")
  createdFilterFolders     FilterFolder[]          @relation("FilterFolderCreator")
  createdFilterTemplates   FilterTemplate[]        @relation("FilterTemplateCreator")
  createdBoards            Board[]                 @relation("BoardCreator")
  createdAutomationFolders AutomationFolder[]      @relation("AutomationFolderCreator")
  createdAutomations       Automation[]            @relation("AutomationCreator")

  // Feedback system
  feedbackPosts    FeedbackPost[]    @relation("FeedbackPostCreator")
  feedbackVotes    FeedbackVote[]    @relation("FeedbackVoteUser")
  feedbackComments FeedbackComment[] @relation("FeedbackCommentUser")
}

model Property {
  id               String               @id @default(cuid())
  address          String               @unique
  zpid             String?
  streetAddress    String?
  city             String?
  state            String?
  zipcode          String?
  bedrooms         Int?
  bathrooms        Float?
  livingArea       Int?
  yearBuilt        Int?
  homeType         String?
  price            Float?
  zestimate        Float?
  priceHistory     Json?
  zestimateHistory Json?
  rawData          Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  motivations      PropertyMotivation[]
  statuses         PropertyStatus[]
  tags             PropertyTag[]
}

model Tag {
  id          String        @id @default(cuid())
  name        String
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User?         @relation("TagCreator", fields: [createdById], references: [id])
  properties  PropertyTag[]
  records     RecordTag[]

  @@unique([name, createdById])
}

model Motivation {
  id          String               @id @default(cuid())
  name        String
  createdById String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdBy   User?                @relation("MotivationCreator", fields: [createdById], references: [id])
  properties  PropertyMotivation[]
  records     RecordMotivation[]

  @@unique([name, createdById])
}

model PropertyTag {
  id         String   @id @default(cuid())
  propertyId String
  tagId      String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id])

  @@unique([propertyId, tagId])
}

model PropertyMotivation {
  id           String     @id @default(cuid())
  propertyId   String
  motivationId String
  createdAt    DateTime   @default(now())
  motivation   Motivation @relation(fields: [motivationId], references: [id])
  property     Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, motivationId])
}

model Status {
  id                String           @id @default(cuid())
  name              String
  color             String
  isDefault         Boolean          @default(false)
  isActive          Boolean          @default(true)
  order             Int              @default(0)
  workability       String           @default("WORKABLE") // WORKABLE, PAUSED, CLOSED_WON, CLOSED_LOST, DNC
  temperatureEffect String? // null, UPGRADE, DOWNGRADE
  createdById       String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdBy         User?            @relation("StatusCreator", fields: [createdById], references: [id])
  properties        PropertyStatus[]
  records           Record[]

  @@unique([name, createdById])
}

model CallResult {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#6B7280")
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  resultType  String   @default("NO_CONTACT") // NO_CONTACT, RETRY, CONTACT_MADE, BAD_DATA, TERMINAL
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("CallResultCreator", fields: [createdById], references: [id])
  records     Record[]

  @@unique([name, createdById])
  @@index([createdById])
}

model PropertyStatus {
  id         String   @id @default(cuid())
  propertyId String
  statusId   String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  status     Status   @relation(fields: [statusId], references: [id])

  @@unique([propertyId, statusId])
}

model Record {
  id                 String    @id @default(cuid())
  ownerFirstName     String?
  ownerLastName      String?
  ownerFullName      String
  isCompany          Boolean   @default(false)
  isCompanyOverride  Boolean?
  propertyStreet     String?
  propertyCity       String?
  propertyState      String?
  propertyZip        String?
  mailingStreet      String?
  mailingCity        String?
  mailingState       String?
  mailingZip         String?
  phone              String?
  email              String?
  notes              String?
  description        String?
  temperature        String?
  estimatedValue     Decimal?
  bedrooms           Int?
  bathrooms          Decimal?
  sqft               Int?
  lotSize            Decimal?
  structureType      String?
  heatingType        String?
  airConditioner     String?
  yearBuilt          Int?
  callAttempts       Int       @default(0)
  directMailAttempts Int       @default(0)
  smsAttempts        Int       @default(0)
  rvmAttempts        Int       @default(0)
  isContact          Boolean   @default(false)
  isComplete         Boolean   @default(false)
  statusId           String?
  callResultId       String?
  assignedToId       String?
  createdById        String?
  skiptraceDate      DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // DockInsight 2.2.2: Denormalized counters for analytics
  phoneCount      Int @default(0)
  emailCount      Int @default(0)
  tagCount        Int @default(0)
  motivationCount Int @default(0)

  // DockInsight v2: Contact Tracking
  lastContactedAt   DateTime? // When was last outreach?
  lastContactType   String? // CALL, SMS, MAIL, RVM, EMAIL
  lastContactResult String? // ANSWERED, VOICEMAIL, NO_ANSWER, WRONG_NUMBER
  hasEngaged        Boolean   @default(false) // Ever had a conversation?

  // DockInsight v2: Snooze feature
  snoozedUntil DateTime? // Hide from queue until this time

  // ==========================================
  // LCE v2.3.1: Lead Cadence Engine Fields
  // ==========================================

  // Priority Score
  priorityScore   Int? // Calculated priority score (0-100+)
  scoreComputedAt DateTime? // When score was last calculated
  scoreVersion    String? // Algorithm version (e.g., "LCE_2_3_1")
  scoreBreakdown  Json? // JSON breakdown of score components

  // Confidence Level
  confidenceLevel String? // HIGH, MEDIUM, LOW

  // Temperature Band (derived from score)
  temperatureBand     String? // HOT, WARM, COLD, ICE (derived from priorityScore)
  bandDemotionCounter Int       @default(0) // Days below threshold for hysteresis
  bandLastCheckedAt   DateTime? // When band was last evaluated

  // Cadence State Machine
  cadenceState      String    @default("NOT_ENROLLED") // NOT_ENROLLED, ACTIVE, SNOOZED, PAUSED, COMPLETED_NO_CONTACT, EXITED_ENGAGED, EXITED_DNC, EXITED_DEAD, EXITED_CLOSED, STALE_ENGAGED, LONG_TERM_NURTURE
  cadenceType       String? // HOT, WARM, COLD, ICE, GENTLE, ANNUAL
  cadenceStep       Int       @default(0) // Current step in cadence (1-indexed)
  cadenceStartDate  DateTime? // When enrolled in current cadence
  cadenceExitDate   DateTime? // When exited cadence
  cadenceExitReason String? // COMPLETED, ANSWERED, DNC, DEAD, MANUAL, CLOSED

  // LCE v3.0: First-to-Market Phases
  currentPhase          String    @default("NEW") // NEW, BLITZ_1, DEEP_PROSPECT, BLITZ_2, MULTI_CHANNEL, NURTURE
  blitzAttempts         Int       @default(0) // Attempts in current blitz phase (resets on phase change)
  lastBlitzDate         DateTime? // Last blitz call date (for daily follow-up tracking)
  deepProspectEnteredAt DateTime? // When entered deep prospecting

  // Next Action
  nextActionType String? // CALL, SMS, RVM, EMAIL
  nextActionDue  DateTime? // When next action is due (UTC date)

  // Engagement & Fatigue
  engagementScore  Int @default(0) // Engagement points
  noResponseStreak Int @default(0) // Consecutive no-responses

  // Re-enrollment
  enrollmentCount  Int       @default(0) // How many cadence cycles
  reEnrollmentDate DateTime? // When eligible for re-enrollment

  // Pause/Snooze reasons
  pausedUntil  DateTime? // When pause expires (if paused with date)
  pausedReason String? // Why paused

  // Callback tracking
  callbackRequestedAt  DateTime? // When callback was requested
  callbackScheduledFor DateTime? // When callback is scheduled

  customFieldValues CustomFieldValue[]
  notifications     Notification[]
  assignedTo        User?                 @relation(fields: [assignedToId], references: [id])
  createdBy         User?                 @relation("RecordCreator", fields: [createdById], references: [id])
  status            Status?               @relation(fields: [statusId], references: [id])
  callResult        CallResult?           @relation(fields: [callResultId], references: [id])
  activityLogs      RecordActivityLog[]
  comments          RecordComment[]
  emails            RecordEmail[]
  recordMotivations RecordMotivation[]
  phoneNumbers      RecordPhoneNumber[]
  recordTags        RecordTag[]
  tasks             Task[]
  boardPositions    RecordBoardPosition[]

  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([createdById, temperature])
  @@index([createdById, statusId])
  @@index([createdById, callResultId])
  @@index([createdById, assignedToId])
  // DockInsight v2: Contact tracking indexes
  @@index([createdById, lastContactedAt])
  @@index([createdById, hasEngaged])
  @@index([snoozedUntil])
  // LCE v2.3.1: Cadence and queue indexes
  @@index([createdById, cadenceState])
  @@index([createdById, nextActionDue])
  @@index([createdById, priorityScore])
  @@index([createdById, temperatureBand])
  @@index([createdById, reEnrollmentDate])
  @@index([cadenceState, nextActionDue])
}

model RecordTag {
  id          String   @id @default(cuid())
  recordId    String
  tagId       String
  createdById String? // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tagId], references: [id])

  @@unique([recordId, tagId])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([recordId])
  @@index([tagId])
}

model RecordMotivation {
  id           String     @id @default(cuid())
  recordId     String
  motivationId String
  createdById  String? // DockInsight 2.2.2: Tenant scope for analytics
  createdAt    DateTime   @default(now())
  motivation   Motivation @relation(fields: [motivationId], references: [id])
  record       Record     @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([recordId, motivationId])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById])
  @@index([createdById, createdAt])
  @@index([recordId])
  @@index([motivationId])
}

model RecordPhoneNumber {
  id          String   @id @default(cuid())
  recordId    String
  number      String
  type        String   @default("MOBILE")
  statuses    String[] @default([])
  createdById String? // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)

  // LCE v2.3.1: Phone-level tracking
  phoneStatus         String    @default("UNVERIFIED") // VALID, UNVERIFIED, WRONG, DISCONNECTED, DNC
  isPrimary           Boolean   @default(false)
  attemptCount        Int       @default(0)
  lastAttemptAt       DateTime?
  lastOutcome         String? // ANSWERED, VOICEMAIL, NO_ANSWER, BUSY, WRONG_NUMBER, DISCONNECTED, DNC
  consecutiveNoAnswer Int       @default(0)

  // DockInsight 2.2.2: Analytics indexes
  @@index([recordId])
  @@index([createdById])
  @@index([createdById, createdAt])
  // LCE v2.3.1: Phone status index
  @@index([recordId, phoneStatus])
}

model RecordEmail {
  id          String   @id @default(cuid())
  recordId    String
  email       String
  isPrimary   Boolean  @default(false)
  createdById String? // DockInsight 2.2.2: Tenant scope for analytics
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)

  // DockInsight 2.2.2: Analytics indexes
  @@index([recordId])
  @@index([createdById])
  @@index([createdById, createdAt])
}

model RecordComment {
  id        String   @id @default(cuid())
  recordId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([recordId])
  @@index([userId])
}

model RecordActivityLog {
  id        String   @id @default(cuid())
  recordId  String
  userId    String?
  action    String
  field     String?
  oldValue  String?
  newValue  String?
  source    String?
  createdAt DateTime @default(now())
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([recordId])
  @@index([userId])
  @@index([createdAt])
}

model CustomFieldDefinition {
  id          String             @id @default(cuid())
  name        String
  fieldType   String
  displayType String             @default("card")
  options     String?
  isRequired  Boolean            @default(false)
  order       Int                @default(0)
  createdById String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  createdBy   User?              @relation("CustomFieldCreator", fields: [createdById], references: [id])
  values      CustomFieldValue[]

  @@unique([name, createdById])
}

model CustomFieldValue {
  id        String                @id @default(cuid())
  value     String?
  fieldId   String
  recordId  String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  record    Record                @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@unique([fieldId, recordId])
  @@index([recordId])
  @@index([fieldId])
}

model ActivityLog {
  id           String   @id @default(cuid())
  type         String
  action       String
  filename     String?
  description  String?
  total        Int      @default(0)
  processed    Int      @default(0)
  status       String   @default("pending")
  metadata     Json?
  errorMessage String?
  userId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User?    @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model Task {
  id              String         @id @default(cuid())
  title           String
  description     String?
  dueDate         DateTime?
  dueTime         String?
  notifyAfter     Int?
  notifyAfterUnit String?
  repeatCount     Int?
  startDate       DateTime?
  recurrence      String?
  recurrenceDays  String[]       @default([])
  skipWeekends    Boolean        @default(false)
  status          String         @default("PENDING")
  priority        String         @default("MEDIUM")
  assignmentType  String         @default("MANUAL")
  assignedToId    String?
  recordId        String?
  createdById     String
  templateId      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?
  notifications   Notification[]
  assignedTo      User?          @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy       User           @relation("TaskCreator", fields: [createdById], references: [id])
  record          Record?        @relation(fields: [recordId], references: [id])
  template        TaskTemplate?  @relation(fields: [templateId], references: [id])

  @@index([assignedToId])
  @@index([recordId])
  @@index([status])
  @@index([dueDate])
  @@index([createdById])
  // DockInsight 2.2.2: Analytics indexes
  @@index([createdById, createdAt])
  @@index([createdById, status])
  @@index([createdById, priority])
}

model TaskTemplate {
  id              String   @id @default(cuid())
  name            String
  title           String
  description     String?
  category        String?
  priority        String   @default("MEDIUM")
  dueDaysFromNow  Int?
  dueTime         String?
  noDueDate       Boolean  @default(false)
  notifyAfter     Int?
  notifyAfterUnit String?
  repeatCount     Int?
  recurrence      String?
  recurrenceDays  String[] @default([])
  skipWeekends    Boolean  @default(false)
  assignmentType  String   @default("MANUAL")
  roundRobinUsers String[] @default([])
  createdById     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       User?    @relation("TaskTemplateCreator", fields: [createdById], references: [id])
  tasks           Task[]

  @@unique([name, createdById])
  @@index([category])
}

model RoundRobinState {
  id           String   @id @default(cuid())
  identifier   String   @unique
  userIds      String[]
  currentIndex Int      @default(0)
  updatedAt    DateTime @updatedAt
}

model Notification {
  id           String    @id @default(cuid())
  userId       String
  type         String
  title        String
  message      String
  taskId       String?
  recordId     String?
  deliveryType String    @default("IMMEDIATE")
  scheduledFor DateTime?
  isRead       Boolean   @default(false)
  readAt       DateTime?
  isDismissed  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  record       Record?   @relation(fields: [recordId], references: [id])
  task         Task?     @relation(fields: [taskId], references: [id])
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

model FilterFolder {
  id          String           @id @default(cuid())
  name        String
  order       Int              @default(0)
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   User?            @relation("FilterFolderCreator", fields: [createdById], references: [id])
  templates   FilterTemplate[]

  @@unique([name, createdById])
}

model FilterTemplate {
  id          String        @id @default(cuid())
  name        String
  filters     Json
  folderId    String?
  folder      FilterFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  order       Int           @default(0)
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User?         @relation("FilterTemplateCreator", fields: [createdById], references: [id])

  @@unique([name, createdById])
  @@index([folderId])
}

// Kanban Board Models
model Board {
  id          String        @id @default(cuid())
  name        String
  description String?
  createdById String
  createdBy   User          @relation("BoardCreator", fields: [createdById], references: [id])
  columns     BoardColumn[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
}

model BoardColumn {
  id        String                @id @default(cuid())
  name      String
  color     String                @default("#6366f1")
  order     Int                   @default(0)
  boardId   String
  board     Board                 @relation(fields: [boardId], references: [id], onDelete: Cascade)
  records   RecordBoardPosition[]
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([boardId])
  @@index([order])
}

model RecordBoardPosition {
  id        String      @id @default(cuid())
  recordId  String
  record    Record      @relation(fields: [recordId], references: [id], onDelete: Cascade)
  columnId  String
  column    BoardColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([recordId, columnId])
  @@index([columnId])
  @@index([recordId])
}

// ==========================================
// AUTOMATION SYSTEM
// ==========================================

model AutomationFolder {
  id          String       @id @default(cuid())
  name        String
  description String?
  color       String       @default("#6366f1")
  order       Int          @default(0)
  createdById String
  createdBy   User         @relation("AutomationFolderCreator", fields: [createdById], references: [id])
  automations Automation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
  @@index([order])
}

model Automation {
  id          String            @id @default(cuid())
  name        String
  description String?
  folderId    String?
  folder      AutomationFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  isActive    Boolean           @default(false)
  isDraft     Boolean           @default(true)

  // Workflow definition stored as JSON
  // Contains: triggers, nodes, edges, viewport
  workflowData Json?

  // Statistics
  runCount  Int       @default(0)
  lastRunAt DateTime?

  createdById String
  createdBy   User            @relation("AutomationCreator", fields: [createdById], references: [id])
  logs        AutomationLog[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([name, createdById])
  @@index([createdById])
  @@index([folderId])
  @@index([isActive])
}

model AutomationLog {
  id           String     @id @default(cuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  recordId     String?

  // Execution details
  triggeredBy String // trigger type that started this run
  status      String    @default("running") // running, completed, failed, skipped
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Step-by-step execution log
  steps Json? // Array of { nodeId, status, startedAt, completedAt, error? }

  // Error tracking
  errorMessage String?
  errorNodeId  String?

  createdAt DateTime @default(now())

  @@index([automationId])
  @@index([recordId])
  @@index([status])
  @@index([createdAt])
}

// ==========================================
// FEEDBACK & FEATURE REQUEST SYSTEM
// ==========================================

model FeedbackPost {
  id           String            @id @default(cuid())
  title        String
  description  String
  status       String            @default("open") // open, in_progress, planned, completed
  category     String            @default("feature") // feature, improvement, bug, other
  voteCount    Int               @default(0) // Denormalized for fast sorting
  commentCount Int               @default(0) // Denormalized for display
  adminNote    String? // Official response from PropSift team
  isPinned     Boolean           @default(false) // Pin important posts to top
  createdById  String
  createdBy    User              @relation("FeedbackPostCreator", fields: [createdById], references: [id])
  votes        FeedbackVote[]
  comments     FeedbackComment[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([status])
  @@index([category])
  @@index([voteCount])
  @@index([createdAt])
  @@index([createdById])
  @@index([isPinned])
}

model FeedbackVote {
  id        String       @id @default(cuid())
  postId    String
  post      FeedbackPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation("FeedbackVoteUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([postId, userId]) // One vote per user per post
  @@index([postId])
  @@index([userId])
}

model FeedbackComment {
  id           String       @id @default(cuid())
  postId       String
  post         FeedbackPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId       String
  user         User         @relation("FeedbackCommentUser", fields: [userId], references: [id], onDelete: Cascade)
  content      String
  isAdminReply Boolean      @default(false) // Highlight admin responses
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// LCE v2.3.1: LEAD CADENCE ENGINE MODELS
// ==========================================

model CadenceTemplate {
  id              String   @id @default(cuid())
  name            String // HOT, WARM, COLD, ICE, GENTLE, ANNUAL or custom
  temperatureBand String // HOT, WARM, COLD, ICE
  description     String?
  totalSteps      Int
  totalDays       Int
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdById     String? // null for system defaults
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  steps CadenceStep[]

  @@unique([name, createdById])
  @@index([temperatureBand])
  @@index([isDefault])
  @@index([createdById])
}

model CadenceStep {
  id          String          @id @default(cuid())
  cadenceId   String
  cadence     CadenceTemplate @relation(fields: [cadenceId], references: [id], onDelete: Cascade)
  stepNumber  Int // 1-indexed
  dayOffset   Int // Days from cadence start
  actionType  String // CALL, SMS, RVM, EMAIL
  description String?
  createdAt   DateTime        @default(now())

  @@unique([cadenceId, stepNumber])
  @@index([cadenceId])
}

model CadenceLog {
  id          String  @id @default(cuid())
  recordId    String
  createdById String? // Tenant scope

  // Attempt tracking
  attemptId   String   @unique @default(cuid()) // UUID for idempotency
  attemptedAt DateTime @default(now())

  // What was attempted
  cadenceType String? // HOT, WARM, COLD, etc.
  stepNumber  Int?
  actionType  String // CALL, SMS, RVM, EMAIL
  phoneId     String? // Which phone was used (for calls)
  phoneNumber String? // The actual number called

  // Outcome (may be null until logged)
  outcome         String? // ANSWERED_INTERESTED, ANSWERED_CALLBACK, ANSWERED_NEUTRAL, ANSWERED_NOT_NOW, ANSWERED_NOT_INTERESTED, VOICEMAIL, NO_ANSWER, BUSY, WRONG_NUMBER, DISCONNECTED, DNC
  outcomeLoggedAt DateTime?
  autoLogged      Boolean   @default(false) // True if outcome was auto-logged after timeout

  // Metadata
  notes        String?
  executedById String? // User who made the call

  createdAt DateTime @default(now())

  @@index([recordId])
  @@index([createdById])
  @@index([attemptedAt])
  @@index([outcome])
  @@index([createdById, attemptedAt])
}

model ComplianceLog {
  id          String  @id @default(cuid())
  recordId    String
  createdById String? // Tenant scope

  // What happened
  action String // DNC_REQUESTED, MARKED_NOT_INTERESTED, MARKED_DEAD, WORKABILITY_BLOCKED
  reason String? // User-provided reason

  // Which phone (if applicable)
  phoneId     String?
  phoneNumber String?

  // Who did it
  executedById String?
  executedAt   DateTime @default(now())

  // Additional context
  notes    String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([recordId])
  @@index([createdById])
  @@index([action])
  @@index([executedAt])
}

model ReconciliationLog {
  id          String  @id @default(cuid())
  createdById String? // Tenant scope (null for system-wide)

  // Run info
  runDate DateTime @default(now())
  runType String   @default("DAILY") // DAILY, MANUAL, STARTUP

  // Statistics
  recordsScanned Int @default(0)
  issuesFound    Int @default(0)
  issuesFixed    Int @default(0)
  manualReview   Int @default(0)

  // Detailed fixes (JSON array)
  fixes Json? // Array of { type, recordId, description, before, after }

  // Health metrics snapshot
  healthMetrics Json? // { activeInCadence, awaitingReEnroll, longTermNurture, notWorkable, getNumbersQueue }

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Status
  status       String  @default("RUNNING") // RUNNING, COMPLETED, FAILED
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([createdById])
  @@index([runDate])
  @@index([status])
}
